<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self' http://localhost:4000 https://cdn.jsdelivr.net https://unpkg.com;
    style-src   'self' 'unsafe-inline' https://cdn.jsdelivr.net;
    img-src     'self' https://github.com https://github.githubassets.com https://avatars.githubusercontent.com data:;
    script-src  'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com http://localhost:4000;
  ">
  <title>My Profile</title>

  <link rel="stylesheet" href="../designs/styles.css">
  <link rel="stylesheet" href="../designs/profile.css"> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap/cal-heatmap.css">

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/cal-heatmap/dist/cal-heatmap.min.js"></script>

</head>
<body>
  <header>
    <h1>👤 My Profile</h1>
    <div class="header-buttons">
      <button onclick="goBack()">⬅ Back</button>
    </div>
  </header>

  <main>
    <div class="profile">
      <img id="avatar" src="" alt="avatar">
      <h2 id="username"></h2>
      <div class="stats">
        <div>📦 Repos: <span id="repos"></span></div>
        <div>🔥 Total Commits: <span id="totalCommits"></span></div>
      </div>
    </div>

    <div id="content-container">
      <div id="pinned-repos">
        <h2>Pinned Repositories</h2>
        <div class="pinned-list"></div>
      </div>

      <div id="cal-heatmap-container">
        <div id="cal-heatmap"></div>
      </div>
    </div>
  </main>

<script>
function goBack() { window.location.href = "./index.html"; }

async function loadProfile() {
  try {
    const res = await fetch("http://localhost:4000/profile");
    const data = await res.json();

    document.getElementById("avatar").src =
      data.avatar_url || "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png";
    document.getElementById("username").textContent = data.username || "Unknown User";
    document.getElementById("repos").textContent = data.repos || 0;
    document.getElementById("totalCommits").textContent = data.totalCommits || 0;

    const reposRes = await fetch("http://localhost:4000/repos");
    const allRepos = await reposRes.json();

    const pinned = allRepos.filter(r => r.isOwner || r.isContributor).slice(0, 6);
    renderPinnedRepos(pinned);

    const cal = new CalHeatmap();
    cal.paint({
      target: "#cal-heatmap",
      data: { source: data.heatmap || [], x: "date", y: "count" },
      date: { start: new Date(new Date().setFullYear(new Date().getFullYear() - 1)) },
      range: 12,
      domain: { type: "month", gutter: 4, label: { text: "MMM", textAlign: "start", position: "top" } },
      subDomain: { type: "day", width: 17, height: 11, gutter: 2, radius: 2 },
      scale: { color: { type: "threshold", domain: [1, 3, 6, 9], range: ["#161b22", "#0e4429", "#006d32", "#26a641", "#39d353"] } }
    });

  } catch (err) { console.error("❌ Failed to load profile:", err); }
}

function renderPinnedRepos(repos) {
  const container = document.querySelector(".pinned-list");
  container.innerHTML = "";

  repos.forEach(r => {
    const el = document.createElement("div");
    el.className = "pinned-card";
    el.innerHTML = `
      <strong>${r.name}</strong><br>
      ⭐ ${r.streak.totalCommits || 0} commits<br>
      <a href="./repo.html?repo=${encodeURIComponent(r.full_name)}">View Details</a>
    `;
    container.appendChild(el);
  });
}

loadProfile();
</script>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    window.electronAPI.initTerminal({
      onHighlight: (elements) => console.log(elements)
    }).then((terminal) => {
      terminal.appendLine("Terminal initialized. Press Ctrl + ` to toggle.");
    });
  });
</script>

</body>
</html>
