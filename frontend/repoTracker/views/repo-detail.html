<!DOCTYPE html>
<html>
<head>
  <title>Repo Details</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="../designs/styles.css">
  <style>
    .highlight { background-color: #3ec777; transition: background 0.3s; }
    .commit-card { margin: 5px 0; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
  </style>
</head>
<body>
  <header>
    <h1 id="repo-title">Repo Details</h1>
    <div class="header-buttons">
      <button id="back-btn">⬅ Back</button>
      <button id="fullscreen-btn">Toggle Fullscreen</button>
    </div>
  </header>

  <main>
    <div id="status" class="loading" style="display:none;"></div>
    <div id="error" class="error" style="display:none;"></div>
    <div class="repo-details">
      <div id="repo-stats" class="stats"></div>
      <canvas id="repo-chart"></canvas>
      <div id="commit-list" class="commit-list"></div>
    </div>
  </main>

<script type="module">
  import { initTerminal } from "../../terminal.js"; // root path

  const API_BASE = "http://localhost:4000";
  let chartInstance = null;
  let commitsData = [];

  const terminal = initTerminal({
    onHighlight: (elements) => {
      if (elements && elements.length) elements[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });

  document.getElementById("fullscreen-btn").addEventListener("click", () => {
    window.electronAPI.toggleFullscreen();
  });
  document.getElementById("back-btn").addEventListener("click", () => {
    window.location.href = "./index.html";
  });

  function calculateStreak(commits) {
    const commitDates = commits.map(c => new Date(c.date).toISOString().split("T")[0]);
    const uniqueDates = [...new Set(commitDates)].sort().reverse();
    let currentStreak = 0, longestStreak = 0, prevDate = null;
    uniqueDates.forEach(d => {
      if (!prevDate) { currentStreak = 1; longestStreak = 1; }
      else {
        const diff = (new Date(prevDate) - new Date(d)) / (1000 * 60 * 60 * 24);
        if (diff === 1) { currentStreak++; longestStreak = Math.max(longestStreak, currentStreak); }
        else currentStreak = 1;
      }
      prevDate = d;
    });
    return { currentStreak, longestStreak, totalCommits: commitDates.length, daysActive: uniqueDates.length };
  }

  async function loadRepo(repoName) {
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const statsEl = document.getElementById("repo-stats");
    const chartEl = document.getElementById("repo-chart");
    const commitListEl = document.getElementById("commit-list");

    statusEl.style.display = "block";
    statusEl.textContent = "Loading repo details...";
    errorEl.style.display = "none";

    try {
      // Fetch repo metadata
      const reposRes = await fetch(`${API_BASE}/repos`);
      const repos = await reposRes.json();
      const repo = repos.find(r => r.full_name === repoName);
      if (!repo) throw new Error("Repo not found");

      // Fetch commits with encoded repoName
      const encodedName = encodeURIComponent(repoName);
      const commitsRes = await fetch(`${API_BASE}/commits/${encodedName}`);
      if (!commitsRes.ok) throw new Error(`Failed to fetch commits: ${commitsRes.status}`);
      commitsData = await commitsRes.json();

      // Compute streak
      const streak = calculateStreak(commitsData);

      // Set title
      document.getElementById("repo-title").textContent = repo.full_name;

      // Render stats
      const contributorsHTML = repo.contributors?.length
        ? `<div class="stat">👥 Contributors: ${
            repo.contributors.map(c => 
              `<a href="https://github.com/${c.login}" target="_blank">${c.login}</a> (${c.contributions})`
            ).join(", ")
          }</div>` : "";

      statsEl.innerHTML = `
        <div class="stat">🔥 Current Streak: ${streak.currentStreak}</div>
        <div class="stat">🏆 Longest Streak: ${streak.longestStreak}</div>
        <div class="stat">🗓 Days Active: ${streak.daysActive}</div>
        <div class="stat">📦 Total Commits: ${streak.totalCommits}</div>
        <div class="stat">🗓 Created: ${new Date(repo.created_at).toLocaleDateString()}</div>
        <div class="stat">🕒 Last Commit: ${new Date(repo.updated_at).toLocaleDateString()}</div>
        ${contributorsHTML}
      `;

      // Chart data
      const commitsByDate = {};
      commitsData.forEach(c => {
        const day = new Date(c.date).toISOString().split("T")[0];
        commitsByDate[day] = (commitsByDate[day] || 0) + 1;
      });
      const sortedDays = Object.keys(commitsByDate).sort();
      const commitsPerDay = sortedDays.map(d => commitsByDate[d]);

      // Render chart
      if (chartInstance) chartInstance.destroy();
      const ctx = chartEl.getContext("2d");
      chartInstance = new Chart(ctx, {
        type: "bar",
        data: { labels: sortedDays, datasets: [{ label: 'Commits per day', data: commitsPerDay, backgroundColor: '#4CAF50' }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, stepSize: 1 } },
          onClick: (evt, elements) => {
            if (!elements.length) return;
            const idx = elements[0].index;
            highlightCommits(sortedDays[idx]);
          }
        }
      });

      // Render commits
      commitListEl.innerHTML = commitsData.map(c => `
        <div class="commit-card" data-date="${new Date(c.date).toISOString().split("T")[0]}">
          <div><strong>${c.sha.substring(0,7)}</strong> - ${c.message}</div>
          <div>Author: ${c.author} | Date: ${new Date(c.date).toLocaleString()}</div>
          <div><a href="${c.url}" target="_blank">View on GitHub</a></div>
        </div>
      `).join("");

    } catch (err) {
      errorEl.style.display = "block";
      errorEl.textContent = err.message;
    } finally {
      statusEl.style.display = "none";
    }
  }

  function highlightCommits(date) {
    const commitCards = Array.from(document.querySelectorAll(`#commit-list .commit-card`));
    const toHighlight = commitCards.filter(el => el.dataset.date === date);
    terminal.highlight(toHighlight);
  }

  // Load repo from query string
  const params = new URLSearchParams(window.location.search);
  const repoName = params.get("repo");
  if (repoName) loadRepo(repoName);
</script>
</body>
</html>
