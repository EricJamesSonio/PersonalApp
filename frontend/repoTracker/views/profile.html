<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self' http://localhost:4000 https://cdn.jsdelivr.net https://unpkg.com;
      style-src   'self' 'unsafe-inline' https://cdn.jsdelivr.net;
      img-src     'self' https://github.com https://github.githubassets.com https://avatars.githubusercontent.com data:;
      script-src  'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
    ">

  <title>My Profile</title>

  <link rel="stylesheet" href="../designs/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap/cal-heatmap.css">

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/cal-heatmap/dist/cal-heatmap.min.js"></script>

  <style>
    body { font-family: sans-serif; margin:0; padding:0; }
    main { display: flex; flex-direction: column; align-items: center; width: 100%; }

    .profile { text-align: center; margin: 20px; }
    .profile img { width: 120px; border-radius: 50%; }
    .stats { margin-top: 10px; display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; }

    #content-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 1200px;
    }

    /* Pinned Repos */
    #pinned-repos { width: 100%; margin-bottom: 20px; }
    .pinned-list {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      justify-items: center;
      width: 100%;
    }
    .pinned-card {
      background-color: #18284b;
      border: 1px solid #1e2a4d;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      width: 100%;
      transition: transform 0.2s;
    }
    .pinned-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    #cal-heatmap-container {
      display: block;
      width: 100%;
      overflow-x: auto;
      padding: 20px;
      background-color: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      margin-top: 20px;
    }
    #cal-heatmap { 
      display: inline-block; 
      min-width: 900px;
      text-align: left;
    }
    .subdomain { shape-rendering: crispEdges; }
    
    /* GitHub-style heatmap cells */
    .ch-domain-text { 
      fill: #8b949e; 
      font-size: 10px; 
      font-weight: 400;
    }
    .ch-subdomain-text { 
      fill: #8b949e; 
      font-size: 9px; 
    }

    /* Responsive */
    @media (max-width: 800px) { .pinned-list { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .pinned-list { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>üë§ My Profile</h1>
    <div class="header-buttons">
      <button onclick="goBack()">‚¨Ö Back</button>
    </div>
  </header>

  <main>
    <div class="profile">
      <img id="avatar" src="" alt="avatar">
      <h2 id="username"></h2>
      <div class="stats">
        <div>üì¶ Repos: <span id="repos"></span></div>
        <div>üî• Total Commits: <span id="totalCommits"></span></div>
      </div>
    </div>

    <div id="content-container">
      <div id="pinned-repos">
        <h2>Pinned Repositories</h2>
        <div class="pinned-list"></div>
      </div>

      <div id="cal-heatmap-container">
        
        <div id="cal-heatmap"></div>
      </div>
    </div>
  </main>

<script>
function goBack() { window.location.href = "./index.html"; }

async function loadProfile() {
  try {
    const res = await fetch("http://localhost:4000/profile");
    const data = await res.json();

    document.getElementById("avatar").src =
      data.avatar_url || "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png";
    document.getElementById("username").textContent = data.username || "Unknown User";
    document.getElementById("repos").textContent = data.repos || 0;
    document.getElementById("totalCommits").textContent = data.totalCommits || 0;

    const reposRes = await fetch("http://localhost:4000/repos");
    const allRepos = await reposRes.json();

    const pinned = allRepos.filter(r => r.isOwner || r.isContributor).slice(0, 6);
    renderPinnedRepos(pinned);

    // GitHub-style heatmap: 7 vertical rows (days), months with labels
    const cal = new CalHeatmap();
    cal.paint({
      target: "#cal-heatmap",
      data: { source: data.heatmap || [], x: "date", y: "count" },
      date: { start: new Date(new Date().setFullYear(new Date().getFullYear() - 1)) },
      range: 12, // 12 months
      domain: { 
        type: "month", 
        gutter: 4,
        label: { text: "MMM", textAlign: "start", position: "top" }
      },
      subDomain: { 
        type: "day", 
        width: 17, 
        height: 11, 
        gutter: 2,
        radius: 2
      },
      scale: { 
        color: { 
          type: "threshold", 
          domain: [1, 3, 6, 9],
          range: ["#161b22", "#0e4429", "#006d32", "#26a641", "#39d353"]
        }
      }
    });

  } catch (err) { console.error("‚ùå Failed to load profile:", err); }
}

function renderPinnedRepos(repos) {
  const container = document.querySelector(".pinned-list");
  container.innerHTML = "";

  repos.forEach(r => {
    const el = document.createElement("div");
    el.className = "pinned-card";
    el.innerHTML = `
      <strong>${r.name}</strong><br>
      ‚≠ê ${r.streak.totalCommits || 0} commits<br>
      <a href="./repo.html?repo=${encodeURIComponent(r.full_name)}">View Details</a>
    `;
    container.appendChild(el);
  });
}

loadProfile();
</script>
</body>
</html>